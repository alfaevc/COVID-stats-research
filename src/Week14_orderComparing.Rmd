---
title: "Week14_orderComparing"
author: "Melody Ma"
date: "12/2/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r, message=FALSE, warning=FALSE, echo = FALSE}
library(tidyverse)
library(ggplot2)
library(dplyr)
library(readr)
library(ggfortify)
library(ggseas)
library(plotly)
library(zoo)
```

## States Mask Order

```{r, message=FALSE, warning=FALSE, echo = FALSE}
# select state, date, event_catg_s, score, newcd_norm_599
data <- read_csv("covid.com.csv") %>% 
  select(c(2, 4:6, 18)) 

# 15M stands for Mandatory Mask/Facecover Order
# See README of COVID_ALL_G1.xlsx
head(data[!is.na(data$EVENT_CATG_S) & data$EVENT_CATG_S == "15M",])
```


```{r}
states = c("WASHINGTON","MASSACHUSETTS","NEW YORK", "TEXAS")

event_order = "15M"
master_df = data.frame(DATE=as.Date(character()),
               NEWCD_NORM_500 = numeric(),
               EVENT_CATG_S=character(),
                STATE=character(),
               DAYS = numeric())

for (i in (1: length(states))){
  # if a state never issues mask order then plot all data
# else the plot starts at the day of mask order
  state1_data = data[data$STATE==states[i],]
  #print(state1_data)
  #state1_mask = data[data$EVENT_CATG_S==event_order,]
  state1_mask = which(!is.na(state1_data$EVENT_CATG_S) & state1_data$EVENT_CATG_S == event_order)
  #print(state1_mask)
  if(!identical(state1_mask, integer(0))){
  state1_data = state1_data[(state1_mask-14):nrow(state1_data),]
  } else{
   states[i] = paste(states[i], "(NO MASK ORDER)")
  }
  #print(state1_data)

  state1_data$DAYS = state1_data$DATE
  state1_data$DAYS = as.numeric(state1_data$DATE-state1_data$DATE[1]-14)
  master_df =rbind(master_df,state1_data)
  #states_df[i] = state1_data
  #states_mask[i] = state1_mask
  #print(master_df)
  
}

# add a new column of moving average
# otherwise interactive plot cannot show date
master_df$newcd_norm_moving <- rollmean(master_df$NEWCD_NORM_500, 7,
                                fill=NA, align="right")

states_trend <- ggplot(data = master_df) +
  geom_line(data = master_df, aes(x = DAYS, y = newcd_norm_moving,
                                  color = STATE, Date=DATE, State=STATE),
            size = 1, alpha = 0.7) +
  # stat_rollapplyr(width = 7, align = "right", size = 1,
  #                   aes(col=STATE, Date=DATE), alpha=0.7)+
  xlab("Number of Days Since Mask Order") + ylab("Normalized Daily New Cases") +
  theme_bw()

interactive_p <- ggplotly(states_trend, tooltip=c("State", "Date"))
interactive_p
```

